
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>College Canteen Menu</title>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    background: #1a1a1a;
    color: #fff;
    padding-top: 70px; /* Space for fixed header */
  }
  
  header {
    background-color: #d02027;
    color: white;
    display: flex;
    justify-content: space-between;
    padding: 1rem 2rem;
    align-items: center;
    box-shadow: 0 3px 16px rgba(0,0,0,0.3);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
  }
  
  header h1 {
    margin: 0;
    font-size: 1.5rem;
    text-align: center;
    flex-grow: 1;
  }
  
  /* Hamburger Menu Styles */
  .nav-toggle {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 3px;
    transition: background 0.3s ease;
  }
  
  .nav-toggle:hover {
    background: rgba(255,255,255,0.1);
  }
  
  .nav-menu {
    position: fixed;
    top: 70px;
    left: -300px;
    width: 280px;
    height: calc(100vh - 70px);
    background: #2d2d2d;
    transition: left 0.3s ease;
    z-index: 999;
    padding: 1rem 0;
    box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    overflow-y: auto;
  }
  
  .nav-menu.active {
    left: 0;
  }
  
  .nav-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 998;
    display: none;
  }
  
  .nav-overlay.active {
    display: block;
  }
  
  .nav-item {
    display: block;
    color: white;
    text-decoration: none;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #444;
    transition: background 0.3s ease;
    font-weight: 500;
    font-size: 1.1rem;
  }
  
  .nav-item:hover {
    background: #d02027;
    color: white;
  }
  
  .nav-item i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
  }
  
  /* Admin Button Styles */
  button#adminLoginBtn, #adminLogoutBtn {
    background: #fff;
    color: #d02027;
    border: none;
    padding: 0.5rem 1rem;
    font-weight: bold;
    cursor: pointer;
    border-radius: 3px;
  }
  
  .menu-section {
    padding: 1rem 2rem;
    scroll-margin-top: 80px; /* For smooth scrolling with fixed header */
  }
  
  .menu-section h2 {
    border-bottom: 2px solid #d02027;
    padding-bottom: 0.25rem;
    margin-top: 2rem;
    text-align: center;
    color: #fff;
    font-size: 2rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  
  .items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }
  
  .item-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 1.2rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    color: #333;
  }
  
  .item-card:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px #00aaff, 0 0 60px #00aaff;
    border: 2px solid #00aaff;
  }
  
  .item-card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 0.7rem;
    background: #f0f0f0;
  }
  
  .item-name {
    font-weight: bold;
    font-size: 1.2rem;
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .item-price {
    color: #d02027;
    font-weight: bold;
    font-size: 1.1rem;
    margin: 0.3rem 0;
  }
  
  .availability {
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .available {
    color: #28a745 !important;
  }
  
  .unavailable {
    color: #dc3545 !important;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    body {
      padding-top: 60px; /* Smaller header on mobile */
    }
    
    header {
      padding: 0.8rem 1rem;
    }
    
    header h1 {
      font-size: 1.2rem;
    }
    
    .nav-menu {
      top: 60px;
      height: calc(100vh - 60px);
    }
    
    .menu-section {
      padding: 1rem;
      scroll-margin-top: 70px;
    }
    
    .menu-section h2 {
      font-size: 1.5rem;
      margin-top: 1rem;
    }
    
    .items-grid {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Smaller cards on mobile */
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .item-card {
      padding: 1rem;
    }
    
    .item-card img {
      height: 100px; /* Smaller images on mobile */
    }
    
    .item-name {
      font-size: 1rem;
    }
    
    .item-price {
      font-size: 1rem;
    }
  }
  
  /* Extra small phones */
  @media (max-width: 480px) {
    .items-grid {
      grid-template-columns: repeat(2, 1fr); /* Always 2 columns on small phones */
      gap: 0.8rem;
    }
    
    .item-card {
      padding: 0.8rem;
    }
    
    .item-card img {
      height: 80px; /* Even smaller images on very small screens */
    }
    
    .item-name {
      font-size: 0.9rem;
    }
    
    .item-price {
      font-size: 0.9rem;
    }
    
    .nav-menu {
      width: 250px; /* Smaller nav menu on small phones */
    }
  }

  /* Admin Panel and other existing styles remain the same */
  #adminPanel {
    position: fixed;
    top: 10%;
    right: 5%;
    left: auto;
    width: 400px;
    max-width: 90vw; /* Responsive admin panel */
    max-height: 80vh;
    overflow-y: auto;
    background: #2d2d2d;
    border: 2px solid #d02027;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 0 20px rgba(208, 32, 39, 0.5);
    display: none;
    z-index: 1000;
    color: #fff;
  }
  
  /* Rest of your existing styles... */
  #adminPanel h3, #adminPanel h4 {
    margin-top: 0;
    color: #fff;
  }
  
  #adminPanel label {
    display: block;
    margin: 0.6rem 0 0.2rem;
    font-weight: bold;
    color: #fff;
  }
  
  #adminPanel input[type="text"], 
  #adminPanel input[type="number"], 
  #adminPanel select {
    width: 100%;
    padding: 0.3rem 0.5rem;
    margin-bottom: 0.6rem;
    border: 1px solid #555;
    border-radius: 4px;
    background: #444;
    color: #fff;
    box-sizing: border-box;
  }
  
  #adminItemsList {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #555;
    margin-bottom: 1rem;
    background: #333;
  }
  
  .admin-item {
    padding: 0.6rem;
    border-bottom: 1px solid #555;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    color: #fff;
  }
  
  .admin-item:last-child {
    border-bottom: none;
  }
  
  .admin-item span {
    font-weight: bold;
    color: #fff;
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .admin-item button {
    margin: 0;
    border: none;
    color: white;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
  }
  
  .admin-item button:hover {
    opacity: 0.8;
  }
  
  #adminAddForm button, #adminSaveBtn {
    background: #d02027;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    font-weight: bold;
    cursor: pointer;
    border-radius: 4px;
    margin-top: 0.8rem;
  }
  
  #overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    z-index: 900;
  }
  
  /* Add a subtle animation to the page load */
  .menu-section {
    animation: fadeInUp 0.6s ease-out;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Make sure text in white cards is readable */
  .item-card * {
    color: #333 !important;
  }
  
  .item-card .item-price {
    color: #d02027 !important;
  }
  
  .item-card .available {
    color: #28a745 !important;
  }
  
  .item-card .unavailable {
    color: #dc3545 !important;
  }
</style>
</head>
<body>

<header>
  <!-- Add Hamburger Menu Button -->
  <button class="nav-toggle" onclick="toggleNav()">☰</button>
  
  <h1>College Canteen Menu</h1>
  
  <div>
    <button id="adminLoginBtn" onclick="adminLogin()">Admin Login</button>
    <button id="adminLogoutBtn" onclick="adminLogout()" style="display: none;">Admin Logout</button>
  </div>
</header>

<!-- UPI QR Code payment -->
<div style="text-align:center; margin-bottom: 1em;">
  <h4>Scan to Pay</h4>
  <img src="upi.jpg" alt="Scan UPI QR to Pay" style="width:220px;max-width:80vw;border-radius:12px;border:2px solid #eee;" />
  <div style="font-size:0.95em; color:#bbb;">Scan to pay with any UPI app</div>
</div>


<!-- User Login/Logout UI -->
<div id="userAuthContainer" style="max-width: 400px; margin: 30px auto; padding: 1em; background: #222; border-radius: 10px; color: #fff; display: none;">
  <h2>Login / Register</h2>
  <form id="loginForm" style="margin-bottom: 1em;">
    <input id="loginUsername" placeholder="Username" style="width: 100%; padding: 0.5em; margin-bottom: 0.3em;" required>
    <input id="loginPassword" type="password" placeholder="Password" style="width: 100%; padding: 0.5em; margin-bottom: 0.3em;" required>
    <button style="width: 100%; padding: 0.6em; background:#d02027; color:#fff; border:none; border-radius: 4px;">Login</button>
  </form>
  <form id="registerForm" style="margin-bottom:1em;">
    <input id="registerUsername" placeholder="New Username" style="width: 100%; padding: 0.5em; margin-bottom: 0.3em;" required>
    <input id="registerPassword" type="password" placeholder="New Password" style="width: 100%; padding: 0.5em; margin-bottom: 0.3em;" required>
    <button style="width: 100%; padding: 0.6em; background:#28a745; color:#fff; border:none; border-radius:4px;">Register</button>
  </form>
  <button id="logoutBtn" style="display:none; width: 100%; padding: 0.6em; background:#d02027; color:#fff; border:none; border-radius:4px;">Logout</button>
  <div id="authStatus" style="margin-top: 0.5e; min-height:1.2em;">Please login</div>
</div>


<!-- Add Navigation Menu -->
<nav class="nav-menu" id="navMenu">
  <a href="#beverages" class="nav-item" onclick="navigateToSection('beverages')">
    <i>🥤</i> Beverages
  </a>
  <a href="#food" class="nav-item" onclick="navigateToSection('food')">
    <i>🍽️</i> Food
  </a>
  <a href="#snacks" class="nav-item" onclick="navigateToSection('snacks')">
    <i>🍿</i> Snacks
  </a>
  <a href="#desserts" class="nav-item" onclick="navigateToSection('desserts')">
    <i>🍰</i> Desserts
  </a>
  <div style="border-top: 1px solid #444; margin: 1rem 0;"></div>
  <a href="#" class="nav-item" onclick="scrollToTop()">
    <i>⬆️</i> Back to Top
  </a>
</nav>

<!-- Navigation Overlay -->
<div class="nav-overlay" id="navOverlay" onclick="closeNav()"></div>

<!-- Cart Icon in Header -->
<button id="cartIconBtn" onclick="openCart()" style="margin-left:10px; background:#fff; color:#d02027; border:none; border-radius:3px; padding:0.4em 1em; font-weight:bold; position:relative;">
  🛒 Cart <span id="cartCount">0</span>
</button>

<!-- Current Order / Bill Section -->
<section id="currentOrderSection" style="max-width:600px; margin: 2rem auto; padding: 1rem; background: #333; border-radius: 10px; color: white; display: none;">
  <h3>Your Current Order</h3>
  <div id="currentOrderList" style="margin-top: 1em;">
    <em>No items added to order yet</em>
  </div>
  <div id="currentOrderTotal" style="margin-top: 1em; font-weight: bold; font-size: 1.2em;"></div>
</section>


<!-- Cart Modal -->
<div id="cartModal" style="display:none; position:fixed; z-index:1200; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
  <div style="background:white; color:#222; border-radius:16px; padding:2em 1.2em; max-width:90vw; width:400px; margin:40px auto; position:relative;">
    <button onclick="closeCart()" style="position:absolute;right:10px;top:10px; background:none; border:none; font-size:1.5em;">✖</button>
    <h2>Your Cart</h2>
    <div id="cartList"></div>
    <div id="cartTotal" style="font-weight:bold; margin:1em 0;"></div>
    <form id="checkoutForm">
      <input type="text" id="checkoutName" placeholder="Your Name" required style="padding:0.5em;width:92%;margin:0.4em 0;">
      <button type="submit" style="width:100%;padding:0.7em;background:#d02027;color:white;font-weight:bold;border-radius:5px;border:none;">Pay & Place Order</button>
    </form>
    <div id="cartResult" style="margin-top:1em;font-size:1.1em;"></div>
  </div>
</div>

<div id="userOrdersContainer" style="max-width:600px; margin:1rem auto; padding:1rem; background:#111; border-radius: 10px; color:#fff; display:none;">
  <h2>Your Past Orders</h2>
  <div id="ordersList"></div>
</div>

<main>
  <div class="menu-section" id="beverages">
  <h2>Beverages</h2>
  <div class="items-grid" id="beveragesItems"></div>
</div>
<div class="menu-section" id="food">
  <h2>Food</h2>
  <div class="items-grid" id="foodItems"></div>
</div>
<div class="menu-section" id="snacks">
  <h2>Snacks</h2>
  <div class="items-grid" id="snacksItems"></div>
</div>
<div class="menu-section" id="desserts">
  <h2>Desserts</h2>
  <div class="items-grid" id="dessertsItems"></div>
</div>
</main>

<!-- Admin Panel -->
<div id="adminPanel">
  <h3>Admin Panel</h3>
  <div id="adminItemsList"></div>

  <h4>Add New Dish</h4>
  <form id="adminAddForm">
    <label for="newName">Name</label>
    <input type="text" id="newName" required />
    
    <label for="newCategory">Category</label>
    <select id="newCategory" required>
      <option value="beverages">Beverages</option>
      <option value="food">Food</option>
      <option value="snacks">Snacks</option>
      <option value="desserts">Desserts</option>
    </select>
    
    <label for="newPrice">Price (₹)</label>
    <input type="number" id="newPrice" min="0" step="0.01" required />
    
    <label for="newImage">Image name (e.g. tea.jpg)</label>
    <input type="text" id="newImage" placeholder="tea.jpg" />
    
    <label for="newAvailability">Available</label>
    <select id="newAvailability" required>
      <option value="true" selected>Yes</option>
      <option value="false">No</option>
    </select>
    
    <button type="submit">Add Dish</button>
  </form>
  
  <button id="adminSaveBtn">Save Changes</button>
</div>

<div id="overlay"></div>

<script>
// Global variables
let menuData = {};
let isAdmin = false;
const SERVER_URL = window.location.origin;

// Helper to convert dish names to image file names
function toImageFile(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-$/, '') + '.jpg';
}

// Fetch menu data from server
async function loadMenuFromServer() {
  try {
    const response = await fetch(`${SERVER_URL}/menu`);
    const data = await response.json();
    menuData = data;
    renderMenu();
  } catch (error) {
    console.error('Error loading menu:', error);
    alert('Could not load menu from server');
  }
}

// Load FULL menu data for admin (with quantities)
async function loadFullMenuFromServer() {
  try {
    const response = await fetch(`${SERVER_URL}/billing/menu`);
    const data = await response.json();
    menuData = data;
    renderMenu();
  } catch (error) {
    console.error('Error loading full menu:', error);
    alert('Could not load full menu from server');
  }
}

// Save menu data to server
async function saveMenuToServer() {
  try {
    const response = await fetch(`${SERVER_URL}/admin/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ menu: menuData })
    });
    const result = await response.json();
    console.log(result.message);
  } catch (error) {
    console.error('Error saving menu:', error);
    alert('Could not save changes to server');
  }
}

/* Removed duplicate declaration of currentUser */

// Show message in auth box
function authMessage(msg, error=false) {
  const el = document.getElementById('authMessage');
  el.style.color = error ? 'red' : 'lightgreen';
  el.textContent = msg;
}

// Login form submit
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!username || !password) return;
  try {
    const res = await fetch('/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username, password})
    });
    const data = await res.json();
    if (res.ok) {
      currentUser = { id: data.userId, username: data.username };
      saveCurrentUser();
      authMessage('Logged in as ' + data.username);
      document.getElementById('userAuthContainer').style.display = 'none';
      document.getElementById('userOrdersContainer').style.display = 'block';
      fetchOrders();
    } else {
      authMessage(data.message || 'Login failed', true);
    }
  } catch(e) {
    authMessage('Error during login', true);
  }
};

// Register form submit
document.getElementById('registerForm').onsubmit = async function(e) {
  e.preventDefault();
  const username = document.getElementById('regUsername').value.trim();
  const password = document.getElementById('regPassword').value;
  if (!username || !password) return;
  try {
    const res = await fetch('/auth/register', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username, password})
    });
    const data = await res.json();
    if (res.ok) {
      authMessage('Registration successful! You can now login.');
      document.getElementById('registerForm').reset();
    } else {
      authMessage(data.message || 'Registration failed', true);
    }
  } catch(e) {
    authMessage('Error during registration', true);
  }
};

function saveCurrentUser() {
  localStorage.setItem('canteenUser', JSON.stringify(currentUser));
}

function loadCurrentUser() {
  const userStr = localStorage.getItem('canteenUser');
  if (userStr) {
    currentUser = JSON.parse(userStr);
    if (currentUser && currentUser.id) {
      authMessage('Welcome back, ' + currentUser.username);
      fetchOrders();
    }
  } else {
    currentUser = null;
  }
  updateUIOnLoginStatus(); // ADD this line here
}

let currentUser = null;

// Load user info from localStorage
function loadUser() {
  const userStr = localStorage.getItem("userInfo");
  if (userStr) {
    currentUser = JSON.parse(userStr);
  } else {
    currentUser = null;
  }
  updateUI(); // Make sure UI reflects if user is logged in or not
}

function renderCurrentOrder() {
  const container = document.getElementById('currentOrderSection');
  const list = document.getElementById('currentOrderList');
  const totalDiv = document.getElementById('currentOrderTotal');
  
  const items = Object.values(cart);
  if (items.length === 0) {
    container.style.display = 'none';
    list.innerHTML = '<em>No items added to order yet</em>';
    totalDiv.textContent = '';
    return;
  }
  
  container.style.display = 'block'; // Show order section
  
  let html = '<table style="width:100%; border-collapse: collapse;">';
  html += `<thead><tr>
    <th style="padding:8px; border-bottom:1px solid #555;">Item</th>
    <th style="padding:8px; border-bottom:1px solid #555;">Qty</th>
    <th style="padding:8px; border-bottom:1px solid #555;">Price</th>
    <th style="padding:8px; border-bottom:1px solid #555;">Subtotal</th>
  </tr></thead><tbody>`;
  
  let total = 0;
  
  items.forEach(item => {
    const subtotal = item.quantity * item.price;
    total += subtotal;
    html += `<tr>
      <td style="padding:8px; border-bottom:1px solid #555;">${item.name}</td>
      <td style="padding:8px; border-bottom:1px solid #555; text-align:center;">${item.quantity}</td>
      <td style="padding:8px; border-bottom:1px solid #555;">₹${item.price.toFixed(2)}</td>
      <td style="padding:8px; border-bottom:1px solid #555;">₹${subtotal.toFixed(2)}</td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  list.innerHTML = html;
  totalDiv.textContent = `Total: ₹${total.toFixed(2)}`;
}

// Call renderCurrentOrder whenever cart is updated, e.g. in addCartItem, removeCartItem, addItemToCart, etc.


function updateUI() {
  const loggedIn = !!currentUser;
  // Show login/register container only if not logged in
  document.getElementById('userAuthContainer').style.display = loggedIn ? 'none' : 'block'; 
  // Show logout button if logged in
  document.getElementById('logoutBtn').style.display = loggedIn ? 'block' : 'none';
  // Optionally show your user orders container here if you have one
  document.getElementById('userOrdersContainer').style.display = loggedIn ? 'block' : 'none';

  // Show welcome message (optional)
  if (loggedIn) {
    document.getElementById('authStatus').textContent = `Welcome, ${currentUser.username}!`;
  } else {
    document.getElementById('authStatus').textContent = 'Please login';
  }
}


// Save user info
function saveUser() {
  if (currentUser) localStorage.setItem("userInfo", JSON.stringify(currentUser));
  else localStorage.removeItem("userInfo");
}

// Update UI based on login state
function updateUI() {
  const loggedIn = !!currentUser;
  document.getElementById('userAuthContainer').style.display = loggedIn ? 'none' : 'block';
  document.getElementById('logoutBtn').style.display = loggedIn ? 'block' : 'none';

  document.getElementById('authStatus').innerText = loggedIn ? 'Logged in as ' + currentUser.username : 'Please login';
  // You can also load user orders etc here if needed
}

// Login form submission
document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const res = await fetch('/auth/login', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username, password})
  });
  if (res.ok) {
    const data = await res.json();
    currentUser = { id: data.userId, username: data.username };
    saveUser();
    updateUI();
    fetchOrders(); // Optional: update order list
  } else {
    alert('Login failed');
  }
};

// Register form submission
document.getElementById('registerForm').onsubmit = async function(e) {
  e.preventDefault();
  const username = document.getElementById('registerUsername').value.trim();
  const password = document.getElementById('registerPassword').value;
  const res = await fetch('/auth/register', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username, password})
  });
  if (res.ok) {
    alert('Registed! Please login');
    document.getElementById('registerForm').reset();
  } else {
    alert('Registration failed');
  }
};

// Logout
document.getElementById('logoutBtn').onclick = () => {
  currentUser = null;
  saveUser();
  updateUI();
};

// Fetch and show user orders
async function fetchOrders() {
  if (!currentUser) return;
  try {
    const res = await fetch('/user/orders/' + currentUser.id);
    const data = await res.json();
    const listDiv = document.getElementById('ordersList');
    if (res.ok) {
      if (data.length === 0) {
        listDiv.innerHTML = '<p>You have not placed any orders yet.</p>';
      } else {
        listDiv.innerHTML = data.map(order => {
          return `
            <div style="border-bottom: 1px solid #444; margin-bottom: 1rem; padding-bottom: 1rem;">
              <strong>Order #: </strong>${order.id}<br>
              <strong>Date: </strong>${new Date(order.timestamp).toLocaleString()}<br>
              <strong>Items:</strong><br>
              <ul>
                ${order.items.map(i => `<li>${i.name} x${i.quantity} = ₹${i.subtotal}</li>`).join('')}
              </ul>
              <strong>Total: ₹${order.total}</strong>
            </div>
          `;
        }).join('');
      }
    } else {
      listDiv.innerHTML = '<p>Error loading orders.</p>';
    }
  } catch(e) {
    document.getElementById('ordersList').innerHTML = '<p>Error while fetching orders.</p>';
  }
}

// When placing order, add userId to order body
const oldCheckout = document.getElementById("checkoutForm").onsubmit;
document.getElementById("checkoutForm").onsubmit = async function(e) {
  e.preventDefault();
  if (!currentUser) {
    authMessage('Please login before placing an order.', true);
    return;
  }
  const checkoutName = document.getElementById('checkoutName').value.trim();
  if (!checkoutName) {
    authMessage('Please enter your name for the order.', true);
    return;
  }
  document.getElementById('cartResult').innerText = 'Processing order...';
  const items = Object.values(cart).map(i => ({id: i.id, quantity: i.quantity}));
  
  try {
    const res = await fetch('/user/order', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId: currentUser.id, items })
    });
    const result = await res.json();
    if (res.ok) {
      document.getElementById('cartResult').innerHTML =
        `<b>Success!</b> Bill:<br>
         Name: ${currentUser.username}<br>
         Order#: ${result.order.id}<br>
         Date: ${new Date(result.order.timestamp).toLocaleString()}<br>
         ${result.order.items.map(it => `${it.name} x${it.quantity} = ₹${it.subtotal}`).join('<br>')}
         <br><b>Total: ₹${result.order.total}</b>`;
      cart = {};
      renderCartIcon();
      loadMenuFromServer && loadMenuFromServer();
      fetchOrders();
    } else {
      document.getElementById('cartResult').innerText = result.message || 'Order failed';
    }
  } catch(e) {
    document.getElementById('cartResult').innerText = 'Error placing order';
  }
};

// Initialize on page load
window.onload = () => {
  loadCurrentUser();
};

// Show or hide login, logout buttons correctly
function updateUIOnLoginStatus() {
  const isLoggedIn = !!currentUser;
  document.getElementById('userAuthContainer').style.display = isLoggedIn ? 'none' : 'block';
  document.getElementById('userOrdersContainer').style.display = isLoggedIn ? 'block' : 'none';
  document.getElementById('logoutBtn').style.display = isLoggedIn ? 'inline-block' : 'none';
}

document.getElementById('logoutBtn').onclick = () => {
  currentUser = null;
  localStorage.removeItem('canteenUser');
  authMessage('Logged out successfully', false);
  updateUIOnLoginStatus();
  // Clear cart and orders display
  cart = {};
  renderCartIcon();
  document.getElementById('ordersList').innerHTML = '';
};

// Call this whenever currentUser changes and after login/logout:
window.onload = () => {
  loadCurrentUser();
  updateUIOnLoginStatus();
};

function updateUIOnLoginStatus() {
  const isLoggedIn = !!currentUser;
  document.getElementById('userAuthContainer').style.display = isLoggedIn ? 'none' : 'block';
  document.getElementById('userOrdersContainer').style.display = isLoggedIn ? 'block' : 'none';
  document.getElementById('logoutBtn').style.display = isLoggedIn ? 'block' : 'none';  // Show logout if logged in
}

document.getElementById('logoutBtn').onclick = () => {
  currentUser = null;
  localStorage.removeItem('canteenUser');
  authMessage('Logged out successfully', false);
  updateUIOnLoginStatus();
  // Clear cart and orders display as needed
  cart = {};
  renderCartIcon();
  document.getElementById('ordersList').innerHTML = '';
};


// === CART FUNCTIONALITY ===

let cart = {};

function renderCartIcon() {
  const count = Object.values(cart).reduce((sum, i) => sum+i.quantity, 0);
  document.getElementById('cartCount').textContent = count;
}

function openCart() {
  renderCart();
  document.getElementById('cartModal').style.display = 'flex';
}

function closeCart() {
  document.getElementById('cartModal').style.display = 'none';
}

function renderCart() {
  const cartList = document.getElementById('cartList');
  if (!cartList) return;
  if (Object.keys(cart).length === 0) {
    cartList.innerHTML = '<em>Your cart is empty.</em>';
    document.getElementById('cartTotal').textContent = '';
    return;
  }
  cartList.innerHTML = Object.values(cart).map(item =>
    `<div style="margin:0.5em 0;">${item.name} x${item.quantity} = ₹${item.price*item.quantity}
      <button onclick="addCartItem(${item.id})" style="margin-left:10px;">+</button>
      <button onclick="removeCartItem(${item.id})">-</button>
    </div>`
  ).join('');
  const total = Object.values(cart).reduce((sum, i) => sum+i.price*i.quantity, 0);
  document.getElementById('cartTotal').textContent = 'Total: ₹' + total;
}

function addCartItem(id) {
  cart[id].quantity++;
  renderCart();
  renderCartIcon();
}
function removeCartItem(id) {
  cart[id].quantity--;
  if (cart[id].quantity <= 0) delete cart[id];
  renderCart();
  renderCartIcon();
}

// Find the item in menu and add to cart
function addItemToCart(item) {
  if (!item.available) {
    alert('This item is not available.');
    return;
  }
  if (!cart[item.id]) {
    cart[item.id] = { ...item, quantity: 1 };
  } else {
    cart[item.id].quantity++;
  }
  renderCartIcon();
}

// Make cart icon always visible in header
document.querySelector('header').appendChild(document.getElementById('cartIconBtn'));

// Add 'Add to Cart' button to menu items
const oldRenderMenu = renderMenu;
renderMenu = function() {
  ['beverages', 'food', 'snacks', 'desserts'].forEach(category => {
    const container = document.getElementById(category + "Items");
    if (!container) return;

    container.innerHTML = '';

    if (!menuData[category]) return;

    menuData[category].forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'item-card';

      const img = document.createElement('img');
      img.src = item.image ? item.image : toImageFile(item.name);
      img.alt = item.name;
      img.onerror = function() {
        this.src = 'https://via.placeholder.com/300x130?text=No+Image';
      };
      card.appendChild(img);

      const name = document.createElement('div');
      name.className = 'item-name';
      name.textContent = item.name;
      card.appendChild(name);

      const price = document.createElement('div');
      price.className = 'item-price';
      price.textContent = `₹${item.price.toFixed(2)}`;
      card.appendChild(price);

      const availability = document.createElement('div');
      availability.className = 'availability';

      if (isAdmin && item.quantity !== undefined) {
        availability.innerHTML = `
          ${item.available ? 'Available' : 'Not Available'}<br>
          <small>Stock: ${item.quantity}</small>
        `;
      } else {
        availability.textContent = item.available ? 'Available' : 'Not Available';
      }
      availability.classList.add(item.available ? 'available' : 'unavailable');
      card.appendChild(availability);

      // Add to Cart button for users
      if (!isAdmin) {
        const addBtn = document.createElement('button');
        addBtn.textContent = "Add to Cart";
        addBtn.style.background = "#d02027";
        addBtn.style.color = "#fff";
        addBtn.style.borderRadius = "5px";
        addBtn.style.padding = "8px 20px";
        addBtn.style.marginTop = "10px";
        addBtn.disabled = !item.available;
        addBtn.onclick = () => addItemToCart(item);
        card.appendChild(addBtn);
      }
      container.appendChild(card);
    });
  });
  renderCartIcon();
}
renderMenu();

// Checkout form handler
document.getElementById("checkoutForm").onsubmit = async function(e) {
  e.preventDefault();
  if (Object.values(cart).length === 0) return;
  const checkoutName = document.getElementById('checkoutName').value.trim();
  if (!checkoutName) return;
  document.getElementById('cartResult').innerText = 'Processing...';
  const items = Object.values(cart).map(item => ({id: item.id, quantity: item.quantity}));
  try {
    const res = await fetch('/user/order', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name: checkoutName, items })
    });
    const result = await res.json();
    if (res.ok) {
  // Compose bill HTML/text
  const billHtml = `
    <b>Success!</b> Bill:<br>
    Name: ${result.order.name}<br>
    Order#: ${result.order.id}<br>
    Date: ${new Date(result.order.timestamp).toLocaleString()}<br>
    <hr>
    ${result.order.items.map(it => `${it.name} x${it.quantity} = ₹${it.subtotal}`).join('<br>')}
    <br><b>Total: ₹${result.order.total}</b>
    <hr>
    <button onclick="downloadBill()">Download Bill</button>
  `;
  document.getElementById('cartResult').innerHTML = billHtml;

  // Save bill data for download
  window.downloadableBill = {
    name: result.order.name,
    orderId: result.order.id,
    date: new Date(result.order.timestamp).toLocaleString(),
    items: result.order.items,
    total: result.order.total
  };

  cart = {};
  renderCartIcon();
  loadMenuFromServer && loadMenuFromServer();
    }
  } catch (error) {
    document.getElementById('cartResult').innerText = 'Error placing order.';
    console.error(error);
  }
};

function downloadBill() {
  if (!window.downloadableBill) return;
  const bill = window.downloadableBill;

  // Format bill as text
  let billText = `College Canteen Bill\n`;
  billText += `--------------------------\n`;
  billText += `Name: ${bill.name}\nOrder #: ${bill.orderId}\nDate: ${bill.date}\n\n`;
  bill.items.forEach(it => {
    billText += `${it.name}  x${it.quantity}  = ₹${it.subtotal}\n`;
  });
  billText += `\nTOTAL: ₹${bill.total}\n--------------------------`;

  // Create a Blob and a download link
  const blob = new Blob([billText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);

  // Download file as e.g. order-3.txt
  const a = document.createElement('a');
  a.href = url;
  a.download = `canteen-bill-order${bill.orderId}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


// Render menu items on the page
function renderMenu() {
  ['beverages', 'food', 'snacks', 'desserts'].forEach(category => {
    const container = document.getElementById(category + "Items");
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!menuData[category]) return;
    
    menuData[category].forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'item-card';

      const img = document.createElement('img');
      img.src = item.image ? item.image : toImageFile(item.name);
      img.alt = item.name;
      img.onerror = function() {
        this.src = 'https://via.placeholder.com/300x130?text=No+Image';
      };
      card.appendChild(img);

      const name = document.createElement('div');
      name.className = 'item-name';
      name.textContent = item.name;
      card.appendChild(name);

      const price = document.createElement('div');
      price.className = 'item-price';
      price.textContent = `₹${item.price.toFixed(2)}`;
      card.appendChild(price);

      const availability = document.createElement('div');
      availability.className = 'availability';
      
      // For admin, show both availability and quantity
      if (isAdmin && item.quantity !== undefined) {
        availability.innerHTML = `
          ${item.available ? 'Available' : 'Not Available'}<br>
          <small>Stock: ${item.quantity}</small>
        `;
      } else {
        availability.textContent = item.available ? 'Available' : 'Not Available';
      }
      
      availability.classList.add(item.available ? 'available' : 'unavailable');
      card.appendChild(availability);

      container.appendChild(card);
    });
  });

}

// FIXED: Render admin items list
function renderAdminItems() {
  const list = document.getElementById('adminItemsList');
  if (!list) return;
  
  list.innerHTML = '';
  
  ['beverages', 'food', 'snacks', 'desserts'].forEach(category => {
    if (!menuData[category]) return;
    
    menuData[category].forEach((item) => {  // FIXED: Use item.id instead of index
      const adminItem = document.createElement('div');
      adminItem.className = 'admin-item';
      adminItem.style.flexWrap = 'wrap';

      const label = document.createElement('span');
      label.textContent = `${item.name} (${category})`;
      label.style.width = '100%';
      label.style.marginBottom = '0.5rem';
      adminItem.appendChild(label);

      // Show stock information if available
      if (item.quantity !== undefined) {
        const stockInfo = document.createElement('small');
        stockInfo.textContent = `Stock: ${item.quantity}`;
        stockInfo.style.color = item.quantity < 10 ? 'red' : 'green';
        stockInfo.style.display = 'block';
        stockInfo.style.marginBottom = '0.5rem';
        adminItem.appendChild(stockInfo);
      }

      // Row 1 buttons
      const buttonRow1 = document.createElement('div');
      buttonRow1.style.display = 'flex';
      buttonRow1.style.gap = '0.3rem';
      buttonRow1.style.marginBottom = '0.3rem';

      // FIXED: Toggle availability using item.id
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = item.available ? 'Mark Unavailable' : 'Mark Available';
      toggleBtn.style.backgroundColor = item.available ? '#555' : '#28a745';
      toggleBtn.style.fontSize = '0.8rem';
      toggleBtn.style.padding = '0.2rem 0.4rem';
      toggleBtn.onclick = async () => {
        // Find the item by ID and toggle availability
        for (let cat of Object.keys(menuData)) {
          const foundItem = menuData[cat].find(menuItem => menuItem.id === item.id);
          if (foundItem) {
            foundItem.available = !foundItem.available;
            break;
          }
        }
        
        await saveMenuToServer();
        await loadFullMenuFromServer(); // Reload full menu data
        renderAdminItems();
      };
      buttonRow1.appendChild(toggleBtn);

      // FIXED: Edit price using item.id
      const priceBtn = document.createElement('button');
      priceBtn.textContent = 'Edit Price';
      priceBtn.style.backgroundColor = '#d02027';
      priceBtn.style.fontSize = '0.8rem';
      priceBtn.style.padding = '0.2rem 0.4rem';
      priceBtn.onclick = async () => {
        const newPrice = prompt('Enter new price for ' + item.name, item.price);
        const parsedPrice = parseFloat(newPrice);
        if (!isNaN(parsedPrice) && parsedPrice >= 0) {
          // Find the item by ID and update price
          for (let cat of Object.keys(menuData)) {
            const foundItem = menuData[cat].find(menuItem => menuItem.id === item.id);
            if (foundItem) {
              foundItem.price = parsedPrice;
              break;
            }
          }
          
          await saveMenuToServer();
          await loadFullMenuFromServer(); // Reload full menu data
          renderAdminItems();
        } else if (newPrice !== null) {
          alert('Invalid price entered');
        }
      };
      buttonRow1.appendChild(priceBtn);

      // FIXED: Rename dish using item.id
      const renameBtn = document.createElement('button');
      renameBtn.textContent = 'Rename';
      renameBtn.style.backgroundColor = '#ff9800';
      renameBtn.style.fontSize = '0.8rem';
      renameBtn.style.padding = '0.2rem 0.4rem';
      renameBtn.onclick = async () => {
        const newName = prompt('Enter new name for ' + item.name, item.name);
        if (newName && newName.trim() !== '' && newName.trim() !== item.name) {
          // Find the item by ID and update name
          for (let cat of Object.keys(menuData)) {
            const foundItem = menuData[cat].find(menuItem => menuItem.id === item.id);
            if (foundItem) {
              foundItem.name = newName.trim();
              // Optionally update image filename to match new name
              if (!foundItem.image || foundItem.image === toImageFile(item.name)) {
                foundItem.image = toImageFile(newName.trim());
              }
              break;
            }
          }
          
          await saveMenuToServer();
          await loadFullMenuFromServer(); // Reload full menu data
          renderAdminItems();
        }
      };
      buttonRow1.appendChild(renameBtn);

      adminItem.appendChild(buttonRow1);

      // Row 2 buttons
      const buttonRow2 = document.createElement('div');
      buttonRow2.style.display = 'flex';
      buttonRow2.style.gap = '0.3rem';

      // FIXED: Edit image using item.id
      const imageBtn = document.createElement('button');
      imageBtn.textContent = 'Edit Image';
      imageBtn.style.backgroundColor = '#6c757d';
      imageBtn.style.fontSize = '0.8rem';
      imageBtn.style.padding = '0.2rem 0.4rem';
      imageBtn.onclick = async () => {
        const newImg = prompt('Enter image filename for ' + item.name, item.image || toImageFile(item.name));
        if (newImg && newImg.trim() !== '') {
          // Find the item by ID and update image
          for (let cat of Object.keys(menuData)) {
            const foundItem = menuData[cat].find(menuItem => menuItem.id === item.id);
            if (foundItem) {
              foundItem.image = newImg.trim();
              break;
            }
          }
          
          await saveMenuToServer();
          await loadFullMenuFromServer(); // Reload full menu data
          renderAdminItems();
        }
      };
      buttonRow2.appendChild(imageBtn);

      // FIXED: Remove dish using item.id  
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.style.backgroundColor = '#dc3545';
      removeBtn.style.fontSize = '0.8rem';
      removeBtn.style.padding = '0.2rem 0.4rem';
      removeBtn.onclick = async () => {
        const confirmRemove = confirm(`Are you sure you want to remove "${item.name}" from the menu?`);
        if (confirmRemove) {
          // Find and remove the item by ID
          for (let cat of Object.keys(menuData)) {
            const itemIndex = menuData[cat].findIndex(menuItem => menuItem.id === item.id);
            if (itemIndex !== -1) {
              menuData[cat].splice(itemIndex, 1);
              break;
            }
          }
          
          await saveMenuToServer();
          await loadFullMenuFromServer(); // Reload full menu data
          renderAdminItems();
        }
      };
      buttonRow2.appendChild(removeBtn);

      // Add restock button if quantity is available
      if (item.quantity !== undefined) {
        const restockBtn = document.createElement('button');
        restockBtn.textContent = 'Restock';
        restockBtn.style.backgroundColor = '#28a745';
        restockBtn.style.fontSize = '0.8rem';
        restockBtn.style.padding = '0.2rem 0.4rem';
        restockBtn.onclick = async () => {
          const additionalStock = prompt(`Add stock for ${item.name} (current: ${item.quantity}):`, '10');
          const parsedStock = parseInt(additionalStock);
          if (!isNaN(parsedStock) && parsedStock > 0) {
            try {
              const response = await fetch(`${SERVER_URL}/admin/restock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: item.id, quantity: parsedStock })
              });
              const result = await response.json();
              alert(result.message);
              await loadFullMenuFromServer(); // Reload full menu data
              renderAdminItems();
            } catch (error) {
              console.error('Error restocking:', error);
              alert('Error restocking item');
            }
          }
        };
        buttonRow2.appendChild(restockBtn);
      }

      adminItem.appendChild(buttonRow2);
      list.appendChild(adminItem);
    });
  });
}

// Show admin panel
function showAdminPanel() {
  document.getElementById('adminPanel').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  // Load full menu data for admin (with quantities)
  loadFullMenuFromServer().then(() => {
    renderAdminItems();
  });
}

function hideAdminPanel() {
  document.getElementById('adminPanel').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  // Reload public menu when closing admin panel
  loadMenuFromServer();
}

function adminLogin() {
  const pwd = prompt('Enter admin password');
  if (pwd === 'canteenadmin123') {
    isAdmin = true;
    document.getElementById('adminLoginBtn').style.display = 'none';
    document.getElementById('adminLogoutBtn').style.display = 'inline-block';
    showAdminPanel();
  } else {
    alert('Wrong password');
  }
}

function adminLogout() {
  isAdmin = false;
  hideAdminPanel();
  document.getElementById('adminLoginBtn').style.display = 'inline-block';
  document.getElementById('adminLogoutBtn').style.display = 'none';
}

// Add new dish - FIXED: Generate unique ID
document.getElementById('adminAddForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('newName').value.trim();
  const category = document.getElementById('newCategory').value;
  const price = parseFloat(document.getElementById('newPrice').value);
  const image = document.getElementById('newImage').value.trim();
  const available = document.getElementById('newAvailability').value === 'true';

  if (!name || isNaN(price)) {
    alert('Please enter valid name and price');
    return;
  }

  // Generate unique ID
  let maxId = 0;
  Object.keys(menuData).forEach(cat => {
    menuData[cat].forEach(item => {
      if (item.id > maxId) maxId = item.id;
    });
  });
  const newId = maxId + 1;

  menuData[category].push({
    id: newId,
    name,
    price,
    available,
    quantity: 50, // Default quantity for new items
    image: image || toImageFile(name)
  });
  
  await saveMenuToServer();
  await loadFullMenuFromServer(); // Reload full menu data
  renderAdminItems();
  e.target.reset();
});

// Save changes button
document.getElementById('adminSaveBtn').addEventListener('click', async () => {
  await saveMenuToServer();
  alert('Changes saved successfully!');
});

// Event listeners
document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);
document.getElementById('overlay').addEventListener('click', hideAdminPanel);

// Load menu when page loads (public view)
loadMenuFromServer();

// Navigation Menu Functions
function toggleNav() {
  const navMenu = document.getElementById('navMenu');
  const navOverlay = document.getElementById('navOverlay');
  
  navMenu.classList.toggle('active');
  navOverlay.classList.toggle('active');
}

function closeNav() {
  const navMenu = document.getElementById('navMenu');
  const navOverlay = document.getElementById('navOverlay');
  
  navMenu.classList.remove('active');
  navOverlay.classList.remove('active');
}

function navigateToSection(sectionId) {
  const section = document.getElementById(sectionId + 'Items').parentElement;
  if (section) {
    section.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  }
  closeNav(); // Close menu after navigation
}

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  closeNav();
}

// Close navigation when clicking outside or pressing escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeNav();
  }
});

// Close nav when window is resized (for better UX)
window.addEventListener('resize', closeNav);
window.onload = () => {
  loadUser();
};


</script>
</body>
</html>
